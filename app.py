import streamlit as st
import google.generativeai as genai

st.set_page_config(page_title="NCTB AI Tutor", layout="wide")

# ржорж╛рж╕рзНржЯрж╛рж░ ржЗржирж╕рзНржЯрзНрж░рж╛ржХрж╢ржи
MASTER_PROMPT = """
рждрзБржорж┐ ржПржХржЬржи ржмрж┐рж╢рзЗрж╖ржЬрзНржЮ ржПржЖржЗ ржЯрж┐ржЙржЯрж░ред ржЖржкрж▓рзЛржб ржХрж░рж╛ PDF ржерзЗржХрзЗ рзирзжрзирзм рж╕рж╛рж▓рзЗрж░ рж╢рж┐ржХрзНрж╖рж╛ржХрзНрж░ржо ржЕржирзБржпрж╛рзЯрзА ржХрж╛ржЬ ржХрж░рзЛред
рзз. рж╕рж╛рж░ржорж░рзНржо: рзл рж▓рж╛ржЗржи (рж╕рж╛ржзрж╛рж░ржг ржлржирзНржЯ, ржХржарж┐ржи рж╢ржмрзНржжрзЗрж░ ржкрж╛рж╢рзЗ ржмржирзНржзржирзАрждрзЗ рж╕рж╣ржЬ ржЕрж░рзНрже)ред
рзи. рззрзжржЯрж┐ рж╕рзГржЬржирж╢рзАрж▓ ржХрж╛ржЬ: (рж╕рж┐рж░рж┐рзЯрж╛рж▓рж╕рж╣ ржмрж╛ржзрзНржпрждрж╛ржорзВрж▓ржХ)ред
рзй. рззрзжржЯрж┐ рж╢ржмрзНржжрж╛рж░рзНрже ржУ рззрзжржЯрж┐ ржПржорж╕рж┐ржХрж┐ржЙ: (рж╕рж┐рж░рж┐рзЯрж╛рж▓рж╕рж╣)ред
рзк. ржЙрждрзНрждрж░: рж╢рзЗрж╖рзЗ "--- ржЙрждрзНрждрж░ ржирж┐ржЪрзЗ ржжрзЗржУрзЯрж╛ рж╣рж▓рзЛ ---" рж╕рзЗржХрж╢ржирзЗ ржерж╛ржХржмрзЗред
"""

st.title("ЁЯУЪ рзирзжрзирзм рж╕рзНржорж╛рж░рзНржЯ ржПржЖржЗ ржЯрж┐ржЙржЯрж░")

with st.sidebar:
    api_key = st.text_input("Gemini API Key ржжрж┐ржи:", type="password")
    chapter = st.selectbox("ржЕржзрзНржпрж╛рзЯ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи:", ["ржЕржзрзНржпрж╛рзЯ рзз", "ржЕржзрзНржпрж╛рзЯ рзи", "ржЕржзрзНржпрж╛рзЯ рзй"])

if api_key:
    genai.configure(api_key=api_key)
    model = genai.GenerativeModel("gemini-1.5-flash", system_instruction=MASTER_PROMPT)
    
    uploaded_file = st.file_uploader("ржмржЗрзЯрзЗрж░ PDF ржЖржкрж▓рзЛржб ржХрж░рзБржи", type=["pdf"])

    if uploaded_file:
        if st.button(f"ЁЯЪА {chapter} рж▓рзЛржб ржХрж░рзЛ"):
            with st.spinner("ржкрж┐ржбрж┐ржПржл ржкрзНрж░рж╕рзЗрж╕ рж╣ржЪрзНржЫрзЗ, ржжрзЯрж╛ ржХрж░рзЗ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржи..."):
                try:
                    # ржлрж╛ржЗрж▓ ржкрзЬрж╛рж░ рж╕ржарж┐ржХ ржкржжрзНржзрждрж┐
                    file_content = uploaded_file.getvalue()
                    
                    # ржкрзНрж░ржорзНржкржЯ рждрзИрж░рж┐
                    q = f"рждрзБржорж┐ {chapter} ржПрж░ рж╕рж╛рж░ржорж░рзНржо, рззрзжржЯрж┐ рж╕рзГржЬржирж╢рзАрж▓ ржХрж╛ржЬ, рззрзжржЯрж┐ рж╢ржмрзНржжрж╛рж░рзНрже ржПржмржВ рззрзжржЯрж┐ ржПржорж╕рж┐ржХрж┐ржЙ ржПржХржмрж╛рж░рзЗ ржжрж╛ржУред"
                    
                    # ржЬрзЗржирж╛рж░рзЗржЯ ржХржирзНржЯрзЗржирзНржЯ
                    response = model.generate_content([
                        {'mime_type': 'application/pdf', 'data': file_content},
                        q
                    ])
                    st.session_state.result = response.text
                except Exception as e:
                    st.error(f"рж╕ржорж╕рзНржпрж╛ржЯрж┐ рж╣рж▓рзЛ: {e}")

        if 'result' in st.session_state:
            st.markdown(st.session_state.result)
            st.divider()
else:
    st.warning("ржЪрж╛рж▓рзБ ржХрж░рждрзЗ рж╕рж╛ржЗржбржмрж╛рж░рзЗ API Key ржжрж┐ржиред")
